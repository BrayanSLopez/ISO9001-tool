<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Auditoría - Historial</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <header class="bg-blue-700 text-white p-4 text-center text-xl font-bold shadow">
    Auditoría - Historial
  </header>

  <div class="p-4">
    <a href="/dashboard.html" class="px-3 py-1 bg-gray-600 text-white rounded">&larr; Volver</a>
  </div>
  <main class="flex-1 p-6 max-w-6xl mx-auto w-full">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-2xl font-semibold">Historial de Auditorías</h2>
    </div>
    <div class="bg-white p-4 rounded shadow mb-6 flex flex-col md:flex-row gap-4 items-end">
      <div class="flex flex-col">
        <label class="text-sm font-semibold">Desde:</label>
        <input type="date" id="filterFrom" class="border rounded p-2"/>
      </div>
      <div class="flex flex-col">
        <label class="text-sm font-semibold">Hasta:</label>
        <input type="date" id="filterTo" class="border rounded p-2"/>
      </div>
      <button id="applyFilterBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Aplicar Filtro</button>
      <button id="clearFilterBtn" class="px-4 py-2 bg-gray-500 text-white rounded">Limpiar</button>
    </div>

    <div id="history" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
    <p id="noDataMsg" class="text-center text-gray-600 mt-8 hidden">No hay auditorías registradas aún.</p>
  </main>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg max-w-3xl w-full p-6 overflow-y-auto max-h-[80vh]">
      <div class="flex items-start justify-between">
        <h3 id="modalTitle" class="text-xl font-bold">Detalle de la Auditoría</h3>
        <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800">✕</button>
      </div>
      <div id="modalMeta" class="mt-2 text-sm text-gray-600"></div>
      <hr class="my-4" />
      <div id="modalContent" class="space-y-3"></div>
      <div class="mt-6 flex justify-between">
        <button id="downloadPdfBtn" class="px-4 py-2 bg-green-600 text-white rounded">Descargar PDF</button>
        <button id="closeModalBtnFooter" class="px-4 py-2 bg-red-600 text-white rounded">Cerrar</button>
      </div>
    </div>
  </div>

  <footer class="bg-gray-800 text-white text-center p-3 text-sm">
    © 2025 ISO9001 Tool - Auditoría
  </footer>

  <script>
    const token = localStorage.getItem('token');
    if (!token) location.href = '/index.html';

    const historyContainer = document.getElementById('history');
    const noDataMsg = document.getElementById('noDataMsg');
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    const modalMeta = document.getElementById('modalMeta');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const closeModalBtnFooter = document.getElementById('closeModalBtnFooter');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const filterFrom = document.getElementById('filterFrom');
    const filterTo = document.getElementById('filterTo');
    const applyFilterBtn = document.getElementById('applyFilterBtn');
    const clearFilterBtn = document.getElementById('clearFilterBtn');

    let allAudits = [];
    let currentAudit = null;

    async function loadHistory() {
      try {
        const res = await fetch('/api/auditoria/history', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();

        allAudits = data.map(a => {
          if (a.items && a.items.length > 0) {
            let score = 0;
            a.items.forEach(it => {
              if (it.estado === "Cumple") score += 1;
              else if (it.estado === "En proceso") score += 0.5;
            });
            a.porcentaje = (score / a.items.length) * 100;
          } else {
            a.porcentaje = null;
          }
          return a;
        });

        renderHistory(allAudits);
      } catch (err) {
        console.error('Error cargando historial:', err);
      }
    }

    function renderHistory(audits) {
      historyContainer.innerHTML = '';
      if (!audits || audits.length === 0) {
        noDataMsg.classList.remove('hidden');
        return;
      }
      noDataMsg.classList.add('hidden');

      audits.forEach(h => {
        const card = document.createElement('article');
        card.className = 'p-4 bg-white rounded shadow flex flex-col';

        let badgeBg = 'bg-green-500';
        let textColor = 'text-white';
        if (typeof h.porcentaje === 'number') {
          if (h.porcentaje < 60) { badgeBg = 'bg-red-700'; }
          else if (h.porcentaje < 70) { badgeBg = 'bg-red-500'; }
          else if (h.porcentaje < 90) { badgeBg = 'bg-yellow-500'; textColor = 'text-black'; }
        } else {
          badgeBg = 'bg-gray-400';
        }

        const title = document.createElement('div');
        title.innerHTML = `<div class="font-bold text-lg">Auditoría #${h.id_checklist}</div>
          <div class="text-sm text-gray-600">Fecha: ${h.fecha_aplicacion ?? 'N/A'}</div>
          <div class="text-sm text-gray-600">Implementador: ${h.implementador ?? 'N/A'}</div>`;

        const footer = document.createElement('div');
        footer.className = 'mt-4 flex items-center gap-3';

        const badge = document.createElement('div');
        badge.className = `w-12 h-12 rounded-full ${badgeBg} flex items-center justify-center font-bold ${textColor}`;
        badge.textContent = (typeof h.porcentaje === 'number') ? `${Math.round(h.porcentaje)}%` : 'N/A';

        const detailBtn = document.createElement('button');
        detailBtn.className = 'ml-auto px-3 py-1 bg-blue-600 text-white rounded';
        detailBtn.textContent = 'Ver detalle';
        detailBtn.addEventListener('click', () => openModal(h));

        footer.appendChild(badge);
        footer.appendChild(detailBtn);

        card.appendChild(title);
        card.appendChild(footer);
        historyContainer.appendChild(card);
      });
    }

    function openModal(a) {
      currentAudit = a;
      modalMeta.innerHTML = `<b>ID:</b> ${a.id_checklist} - <b>Fecha:</b> ${a.fecha_aplicacion ?? 'N/A'}<br>
        <b>Implementador:</b> ${a.implementador ?? 'N/A'} - <b>Puntaje:</b> ${a.porcentaje ? Math.round(a.porcentaje) : 'N/A'}%`;

      modalContent.innerHTML = '';
      if (!a.items || a.items.length === 0) {
        modalContent.innerHTML = `<p>No hay ítems registrados en esta auditoría.</p>`;
      } else {
        a.items.forEach(it => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'p-3 border rounded';

          itemDiv.innerHTML = `<b>${it.numero_item}</b> - ${it.estado}<br>
            ${it.comentario ? `<i>${it.comentario}</i>` : ''}`;

          modalContent.appendChild(itemDiv);
        });
      }

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeModal() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    closeModalBtn.addEventListener('click', closeModal);
    closeModalBtnFooter.addEventListener('click', closeModal);
    downloadPdfBtn.addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Informe de Auditoría", 10, 10);
      doc.save(`auditoria_${currentAudit.id_checklist}.pdf`);
    });

    loadHistory();
  </script>
</body>
</html>


