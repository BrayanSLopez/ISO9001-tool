<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Auditoría - Historial</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF para exportar a PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-blue-700 text-white p-4 text-center text-xl font-bold shadow">
    Auditoría - Historial
  </header>

  <!-- Contenido -->
  <main class="flex-1 p-6 max-w-6xl mx-auto w-full">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-2xl font-semibold">Historial de Auditorías</h2>
      <a href="/dashboard.html" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Volver al Dashboard</a>
    </div>

    <!-- Filtros -->
    <div class="bg-white p-4 rounded shadow mb-6 flex flex-col md:flex-row gap-4 items-end">
      <div class="flex flex-col">
        <label class="text-sm font-semibold">Desde:</label>
        <input type="date" id="filterFrom" class="border rounded p-2"/>
      </div>
      <div class="flex flex-col">
        <label class="text-sm font-semibold">Hasta:</label>
        <input type="date" id="filterTo" class="border rounded p-2"/>
      </div>
      <button id="applyFilterBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Aplicar Filtro</button>
      <button id="clearFilterBtn" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Limpiar</button>
    </div>

    <!-- Historial -->
    <div id="history" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
    <p id="noDataMsg" class="text-center text-gray-600 mt-8 hidden">No hay auditorías registradas aún.</p>
  </main>

  <!-- Modal flotante -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg max-w-3xl w-full p-6 overflow-y-auto max-h-[80vh]" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="flex items-start justify-between">
        <h3 id="modalTitle" class="text-xl font-bold">Detalle de la Auditoría</h3>
        <button id="closeModalBtn" aria-label="Cerrar" class="text-gray-500 hover:text-gray-800">✕</button>
      </div>

      <div id="modalMeta" class="mt-2 text-sm text-gray-600"></div>
      <hr class="my-4" />
      <div id="modalContent" class="space-y-3"></div>

      <div class="mt-6 flex justify-between">
        <button id="downloadPdfBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Descargar PDF</button>
        <button id="closeModalBtnFooter" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white text-center p-3 text-sm">
    © 2025 ISO9001 Tool - Auditoría
  </footer>

  <script>
    const token = localStorage.getItem('token');
    if (!token) location.href = '/index.html';

    const historyContainer = document.getElementById('history');
    const noDataMsg = document.getElementById('noDataMsg');
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    const modalMeta = document.getElementById('modalMeta');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const closeModalBtnFooter = document.getElementById('closeModalBtnFooter');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const filterFrom = document.getElementById('filterFrom');
    const filterTo = document.getElementById('filterTo');
    const applyFilterBtn = document.getElementById('applyFilterBtn');
    const clearFilterBtn = document.getElementById('clearFilterBtn');

    let allAudits = [];
    let currentAudit = null;

    async function loadHistory() {
      try {
        const res = await fetch('/api/auditoria/history', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) {
          console.error('Error cargando historial:', res.status);
          historyContainer.innerHTML = `<div class="col-span-full text-red-600">Error cargando historial (${res.status})</div>`;
          return;
        }
        const data = await res.json();
        allAudits = data;
        renderHistory(data);
      } catch (err) {
        console.error('Error fetching history:', err);
        historyContainer.innerHTML = `<div class="col-span-full text-red-600">Error de conexión</div>`;
      }
    }

    function renderHistory(audits) {
      historyContainer.innerHTML = '';
      if (!audits || audits.length === 0) {
        noDataMsg.classList.remove('hidden');
        return;
      }
      noDataMsg.classList.add('hidden');

      audits.forEach(h => {
        const card = document.createElement('article');
        card.className = 'p-4 bg-white rounded shadow hover:shadow-lg transition flex flex-col';

        let badgeBg = 'bg-green-500';
        let textColor = 'text-white';
        if (typeof h.porcentaje === 'number') {
          if (h.porcentaje < 60) { badgeBg = 'bg-red-700'; textColor = 'text-white'; }
          else if (h.porcentaje < 70) { badgeBg = 'bg-red-500'; }
          else if (h.porcentaje < 90) { badgeBg = 'bg-yellow-500'; textColor = 'text-black'; }
        } else {
          badgeBg = 'bg-gray-400';
        }

        const title = document.createElement('div');
        title.innerHTML = `<div class="font-bold text-lg">Auditoría #${h.id_checklist ?? ''}</div>
          <div class="text-sm text-gray-600 mt-1">Fecha: ${h.fecha_aplicacion ?? 'N/A'}</div>
          <div class="text-sm text-gray-600">Implementador: ${h.implementador ?? 'N/A'}</div>`;

        const footer = document.createElement('div');
        footer.className = 'mt-4 flex items-center gap-3';

        const badge = document.createElement('div');
        badge.className = `w-12 h-12 rounded-full ${badgeBg} flex items-center justify-center font-bold ${textColor}`;
        badge.textContent = (typeof h.porcentaje === 'number') ? `${Math.round(h.porcentaje)}%` : 'N/A';

        const detailBtn = document.createElement('button');
        detailBtn.className = 'ml-auto px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm';
        detailBtn.type = 'button';
        detailBtn.textContent = 'Ver detalle';
        detailBtn.addEventListener('click', () => openModal(h));

        footer.appendChild(badge);
        footer.appendChild(detailBtn);

        card.appendChild(title);
        card.appendChild(footer);

        historyContainer.appendChild(card);
      });
    }

    function openModal(auditoria) {
      currentAudit = auditoria;
      modalMeta.innerHTML = `
        <div><b>ID:</b> ${auditoria.id_checklist ?? ''} &nbsp; <b>Fecha:</b> ${auditoria.fecha_aplicacion ?? 'N/A'}</div>
        <div class="mt-1"><b>Implementador:</b> ${auditoria.implementador ?? 'N/A'} &nbsp; <b>Puntaje:</b> ${auditoria.porcentaje ?? 'N/A'}%</div>
      `;

      modalContent.innerHTML = '';
      if (!auditoria.items || auditoria.items.length === 0) {
        modalContent.innerHTML = `<p class="text-gray-600">No hay ítems registrados en esta auditoría.</p>`;
      } else {
        auditoria.items.forEach(it => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'p-3 border rounded flex flex-col gap-2';

          const header = document.createElement('div');
          header.className = 'flex items-center justify-between';

          const numero = document.createElement('span');
          numero.className = 'font-semibold';
          numero.textContent = it.numero_item ?? it.item ?? 'Ítem';

          const estadoSpan = document.createElement('span');
          estadoSpan.className = 'px-2 py-1 rounded text-xs font-medium';
          if (it.estado === 'Cumple') estadoSpan.classList.add('bg-green-100','text-green-800');
          else if (it.estado === 'En proceso') estadoSpan.classList.add('bg-yellow-100','text-yellow-800');
          else estadoSpan.classList.add('bg-red-100','text-red-800');
          estadoSpan.textContent = it.estado ?? 'N/A';

          header.appendChild(numero);
          header.appendChild(estadoSpan);
          itemDiv.appendChild(header);

          if (it.comentario) {
            const comentario = document.createElement('div');
            comentario.className = 'mt-2 text-sm text-gray-700';
            comentario.innerHTML = `<b>Comentario:</b> ${escapeHtml(it.comentario)}`;
            itemDiv.appendChild(comentario);
          }
          modalContent.appendChild(itemDiv);
        });
      }
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.style.overflow = '';
    }

    function escapeHtml(unsafe) {
      return String(unsafe).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    async function downloadPdf() {
      if (!currentAudit) return;
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("Informe de Auditoría", 10, 20);
      doc.setFontSize(12);
      doc.text(`ID: ${currentAudit.id_checklist}`, 10, 30);
      doc.text(`Fecha: ${currentAudit.fecha_aplicacion ?? 'N/A'}`, 10, 38);
      doc.text(`Implementador: ${currentAudit.implementador ?? 'N/A'}`, 10, 46);
      doc.text(`Puntaje: ${currentAudit.porcentaje ?? 'N/A'}%`, 10, 54);

      let y = 70;
      if (currentAudit.items && currentAudit.items.length > 0) {
        doc.setFontSize(14);
        doc.text("Detalle de Ítems:", 10, y);
        y += 8;
        doc.setFontSize(11);
        currentAudit.items.forEach(it => {
          if (y > 270) { doc.addPage(); y = 20; }
          doc.text(`${it.numero_item ?? ''} - ${it.estado ?? ''}`, 10, y);
          y += 6;
          if (it.comentario) {
            doc.text(`Comentario: ${it.comentario}`, 15, y);
            y += 6;
          }
        });
      }
      doc.save(`auditoria_${currentAudit.id_checklist}.pdf`);
    }

    function applyFilter() {
      const fromDate = filterFrom.value ? new Date(filterFrom.value) : null;
      const toDate = filterTo.value ? new Date(filterTo.value) : null;
      let filtered = allAudits;

      if (fromDate) {
        filtered = filtered.filter(a => new Date(a.fecha_aplicacion) >= fromDate);
      }
      if (toDate) {
        filtered = filtered.filter(a => new Date(a.fecha_aplicacion) <= toDate);
      }
      renderHistory(filtered);
    }

    closeModalBtn.addEventListener('click', closeModal);
    closeModalBtnFooter.addEventListener('click', closeModal);
    downloadPdfBtn.addEventListener('click', downloadPdf);
    applyFilterBtn.addEventListener('click', applyFilter);
    clearFilterBtn.addEventListener('click', () => {
      filterFrom.value = '';
      filterTo.value = '';
      renderHistory(allAudits);
    });

    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
    loadHistory();
  </script>
</body>
</html>
