<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Auditoría - Historial</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body class="min-h-screen font-sans text-gray-900 bg-gradient-to-tr from-blue-900 via-blue-500 to-blue-200 bg-fixed flex flex-col">
  <!-- Header -->
  <header class="flex justify-between items-center py-4 px-6 bg-gray-50/90 rounded-xl shadow-md mt-4 border border-gray-200 max-w-4xl mx-auto w-full">
    <div class="flex items-center gap-3">
      <i class="fa-solid fa-magnifying-glass-chart text-3xl text-indigo-700"></i>
      <span class="text-2xl font-extrabold text-indigo-700 tracking-tight">Auditoría - Historial</span>
    </div>
    <a href="/dashboard.html" class="flex items-center gap-2 px-4 py-2 border border-indigo-600 text-indigo-600 rounded-lg hover:bg-indigo-600 hover:text-white transition-all font-semibold shadow-sm">
      <i class="fa-solid fa-arrow-left"></i>
      Volver
    </a>
  </header>

  <main class="flex-1 flex flex-col justify-center w-full max-w-4xl mx-auto">
    <section class="mt-8 bg-gray-50/90 p-8 rounded-2xl shadow-2xl border border-gray-200">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-indigo-900 flex items-center gap-2"><i class="fa-solid fa-clipboard-list text-indigo-600"></i>Historial de Auditorías</h2>
      </div>
      <div class="bg-white/90 p-4 rounded-xl shadow mb-6 flex flex-col md:flex-row gap-4 items-end border border-indigo-100">
        <div class="flex flex-col">
          <label class="text-sm font-semibold text-indigo-900">Desde:</label>
          <input type="date" id="filterFrom" class="border rounded p-2"/>
        </div>
        <div class="flex flex-col">
          <label class="text-sm font-semibold text-indigo-900">Hasta:</label>
          <input type="date" id="filterTo" class="border rounded p-2"/>
        </div>
        <button id="applyFilterBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold flex items-center gap-2"><i class="fa-solid fa-filter"></i>Aplicar Filtro</button>
        <button id="clearFilterBtn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-700 font-semibold flex items-center gap-2"><i class="fa-solid fa-eraser"></i>Limpiar</button>
      </div>

      <div id="history" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
      <p id="noDataMsg" class="text-center text-gray-600 mt-8 hidden">No hay auditorías registradas aún.</p>
    </section>
  </main>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white/95 rounded-2xl shadow-2xl max-w-3xl w-full p-6 overflow-y-auto max-h-[80vh] border border-gray-200">
      <div class="flex items-start justify-between">
        <h3 id="modalTitle" class="text-xl font-bold text-indigo-900 flex items-center gap-2"><i class="fa-solid fa-file-lines text-indigo-600"></i>Detalle de la Auditoría</h3>
        <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl">✕</button>
      </div>
      <div id="modalMeta" class="mt-2 text-sm text-gray-600"></div>
      <hr class="my-4" />
      <div id="modalContent" class="space-y-3"></div>
      <div class="mt-6 flex justify-between">
        <button id="downloadPdfBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold flex items-center gap-2"><i class="fa-solid fa-file-arrow-down"></i>Descargar PDF</button>
        <button id="closeModalBtnFooter" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold flex items-center gap-2"><i class="fa-solid fa-xmark"></i>Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="mt-10 text-center text-white text-sm py-4 border-t border-indigo-300 bg-indigo-800/90 rounded-b-xl shadow-lg w-full max-w-4xl mx-auto">
    <div class="flex flex-col md:flex-row justify-center items-center gap-2">
      <span class="font-semibold">&copy; 2025 ISO9001 Tool - Auditoría</span>
      <span class="hidden md:inline">|</span>
      <a href="mailto:soporte@iso9001tool.com" class="hover:underline text-cyan-200 font-medium"><i class="fa-solid fa-envelope"></i> Contacto</a>
      <span class="hidden md:inline">|</span>
      <a href="https://www.iso.org/iso-9001-quality-management.html" target="_blank" class="hover:underline text-cyan-200 font-medium"><i class="fa-solid fa-globe"></i> Más sobre ISO 9001</a>
    </div>
  </footer>

  <script>
    const token = localStorage.getItem('token');
    if (!token) location.href = '/index.html';

    const historyContainer = document.getElementById('history');
    const noDataMsg = document.getElementById('noDataMsg');
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    const modalMeta = document.getElementById('modalMeta');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const closeModalBtnFooter = document.getElementById('closeModalBtnFooter');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const filterFrom = document.getElementById('filterFrom');
    const filterTo = document.getElementById('filterTo');
    const applyFilterBtn = document.getElementById('applyFilterBtn');
    const clearFilterBtn = document.getElementById('clearFilterBtn');

    let allAudits = [];
    let currentAudit = null;

    async function loadHistory() {
      try {
        const res = await fetch('/api/auditoria/history', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();

        allAudits = data.map(a => {
          if (a.items && a.items.length > 0) {
            let score = 0;
            a.items.forEach(it => {
              if (it.estado === "Cumple") score += 1;
              else if (it.estado === "En proceso") score += 0.5;
            });
            a.porcentaje = (score / a.items.length) * 100;
          } else {
            a.porcentaje = null;
          }
          return a;
        });

        renderHistory(allAudits);
      } catch (err) {
        console.error('Error cargando historial:', err);
      }
    }

    function renderHistory(audits) {
      historyContainer.innerHTML = '';
      if (!audits || audits.length === 0) {
        noDataMsg.classList.remove('hidden');
        return;
      }
      noDataMsg.classList.add('hidden');

      audits.forEach(h => {
        const card = document.createElement('article');
        card.className = 'p-4 bg-white rounded shadow flex flex-col';

        let badgeBg = 'bg-green-500';
        let textColor = 'text-white';
        if (typeof h.porcentaje === 'number') {
          if (h.porcentaje < 60) { badgeBg = 'bg-red-700'; }
          else if (h.porcentaje < 70) { badgeBg = 'bg-red-500'; }
          else if (h.porcentaje < 90) { badgeBg = 'bg-yellow-500'; textColor = 'text-black'; }
        } else {
          badgeBg = 'bg-gray-400';
        }

        const title = document.createElement('div');
        title.innerHTML = `<div class="font-bold text-lg">Auditoría #${h.id_checklist}</div>
          <div class="text-sm text-gray-600">Fecha: ${h.fecha_aplicacion ?? 'N/A'}</div>
          <div class="text-sm text-gray-600">Implementador: ${h.implementador ?? 'N/A'}</div>`;

        const footer = document.createElement('div');
        footer.className = 'mt-4 flex items-center gap-3';

        const badge = document.createElement('div');
        badge.className = `w-12 h-12 rounded-full ${badgeBg} flex items-center justify-center font-bold ${textColor}`;
        badge.textContent = (typeof h.porcentaje === 'number') ? `${Math.round(h.porcentaje)}%` : 'N/A';

        const detailBtn = document.createElement('button');
        detailBtn.className = 'ml-auto px-3 py-1 bg-blue-600 text-white rounded';
        detailBtn.textContent = 'Ver detalle';
        detailBtn.addEventListener('click', () => openModal(h));

        footer.appendChild(badge);
        footer.appendChild(detailBtn);

        card.appendChild(title);
        card.appendChild(footer);
        historyContainer.appendChild(card);
      });
    }

    function openModal(a) {
      currentAudit = a;
      modalMeta.innerHTML = `<b>ID:</b> ${a.id_checklist} - <b>Fecha:</b> ${a.fecha_aplicacion ?? 'N/A'}<br>
        <b>Implementador:</b> ${a.implementador ?? 'N/A'} - <b>Puntaje:</b> ${a.porcentaje ? Math.round(a.porcentaje) : 'N/A'}%`;

      modalContent.innerHTML = '';
      if (!a.items || a.items.length === 0) {
        modalContent.innerHTML = `<p>No hay ítems registrados en esta auditoría.</p>`;
      } else {
        a.items.forEach(it => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'p-3 border rounded';

          itemDiv.innerHTML = `<b>${it.numero_item}</b> - ${it.estado}<br>
            ${it.comentario ? `<i>${it.comentario}</i>` : ''}`;

          modalContent.appendChild(itemDiv);
        });
      }

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeModal() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    closeModalBtn.addEventListener('click', closeModal);
    closeModalBtnFooter.addEventListener('click', closeModal);
    downloadPdfBtn.addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Informe de Auditoría", 10, 10);
      doc.save(`auditoria_${currentAudit.id_checklist}.pdf`);
    });

    loadHistory();
  </script>
</body>
</html>


