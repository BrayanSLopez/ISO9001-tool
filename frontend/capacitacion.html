<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Capacitaci√≥n</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Header -->
  <header class="bg-blue-700 text-white p-4 text-center text-xl font-bold shadow">
    Capacitaci√≥n - Historial
  </header>

  <!-- Bot√≥n volver -->
  <div class="p-4">
    <a href="/dashboard.html" class="px-3 py-1 bg-gray-600 text-white rounded">&larr; Volver</a>
  </div>

  <div class="max-w-3xl mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-xl font-bold mb-4">Capacitaci√≥n</h2>

    <!-- Lista de categor√≠as -->
    <div id="categorias" class="space-y-3"></div>
  </div>

  <!-- Modal -->
  <div id="modal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white p-6 rounded shadow-lg w-96 relative">
      <h2 id="modalTitle" class="text-lg font-bold mb-4">Documento</h2>

      <!-- Enlace al documento base -->
      <a href="/docs/Organigrama+Formato.xlsx" class="text-blue-600 underline block mb-3" target="_blank">
        Descargar documento base
      </a>

      <!-- Enlace al archivo subido -->
      <div id="archivoEnlace" class="mb-3 hidden">
        <span class="font-medium">Archivo actual:</span>
        <a id="archivoLink" href="#" target="_blank" class="text-blue-600 underline ml-2"></a>
        <div id="archivoFecha" class="text-xs text-gray-500"></div>
      </div>

      <!-- Subir archivo -->
      <input type="file" id="fileInput" class="mb-3" />
      <button onclick="uploadFile()" class="px-4 py-2 bg-blue-600 text-white rounded">Subir archivo</button>

      <!-- Barra de progreso -->
      <div class="w-full bg-gray-200 rounded-full h-2.5 mt-3 hidden" id="progressContainer">
        <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
      </div>

      <!-- Mensaje -->
      <p id="mensaje" class="mt-3 text-sm"></p>

      <!-- Cerrar -->
      <button onclick="closeModal()" class="absolute top-2 right-2 text-gray-500">&times;</button>
    </div>
  </div>

<script>
const token = localStorage.getItem('token');
if (!token) location.href = '/index.html';

let currentCategory = null;
let currentCategoryName = null;
let existingFile = null;

// Categor√≠as fijas
const categorias = [
  { id: 'objetivos', nombre: 'Objetivos y Beneficios', color: 'bg-blue-600 hover:bg-blue-700' },
  { id: 'phva', nombre: 'Ciclo PHVA', color: 'bg-green-600 hover:bg-green-700' },
  { id: 'organizacion', nombre: 'Organizaci√≥n', color: 'bg-indigo-600 hover:bg-indigo-700' },
  { id: 'liderazgo', nombre: 'Liderazgo', color: 'bg-purple-600 hover:bg-purple-700' },
  { id: 'planificacion', nombre: 'Planificaci√≥n', color: 'bg-teal-600 hover:bg-teal-700' },
  { id: 'apoyo', nombre: 'Apoyo', color: 'bg-pink-600 hover:bg-pink-700' },
  { id: 'operacion', nombre: 'Operaci√≥n', color: 'bg-yellow-600 hover:bg-yellow-700' },
  { id: 'desempeno', nombre: 'Desempe√±o', color: 'bg-orange-600 hover:bg-orange-700' },
  { id: 'mejora', nombre: 'Mejora', color: 'bg-red-600 hover:bg-red-700' },
  { id: 'auditoria', nombre: 'Auditor√≠a', color: 'bg-gray-800 hover:bg-gray-900' }
];

// Render categor√≠as con iconos
async function renderCategorias() {
  const res = await fetch('/api/capacitacion/myfiles', {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const files = await res.json();
  const container = document.getElementById('categorias');
  container.innerHTML = '';

  categorias.forEach(cat => {
    const file = files.find(f => f.categoria === cat.id);
    const icon = file ? '‚úÖ' : 'üìÇ';
    const btn = document.createElement('button');
    btn.className = `w-full text-left px-4 py-3 text-white rounded ${cat.color}`;
    btn.innerHTML = `${icon} ${cat.nombre}`;
    btn.onclick = () => openModal(cat.id, cat.nombre);
    container.appendChild(btn);
  });
}

// Abrir modal
function openModal(category, name) {
  currentCategory = category;
  currentCategoryName = name;
  document.getElementById('modalTitle').innerText = name;
  document.getElementById('mensaje').innerText = '';
  document.getElementById('fileInput').value = '';
  document.getElementById('progressContainer').classList.add('hidden');
  existingFile = null;

  // Cargar archivo actual del usuario
  fetch('/api/capacitacion/myfiles', {
    headers: { 'Authorization': 'Bearer ' + token }
  })
    .then(res => res.json())
    .then(data => {
      const f = data.find(x => x.categoria === category);
      if (f) {
        existingFile = f;
        document.getElementById('archivoLink').innerText = f.nombre_original;
        document.getElementById('archivoLink').href = f.ruta_archivo;
        document.getElementById('archivoFecha').innerText = `√öltima actualizaci√≥n: ${f.fecha_subida}`;
        document.getElementById('archivoEnlace').classList.remove('hidden');
      } else {
        document.getElementById('archivoEnlace').classList.add('hidden');
      }
    });

  document.getElementById('modal').classList.remove('hidden');
}

// Cerrar modal
function closeModal() {
  document.getElementById('modal').classList.add('hidden');
}

// Subir archivo con confirmaci√≥n y progreso
function uploadFile() {
  const file = document.getElementById('fileInput').files[0];
  if (!file) {
    alert("Selecciona un archivo");
    return;
  }

  if (existingFile && !confirm("Ya existe un archivo en esta categor√≠a. ¬øDeseas reemplazarlo?")) {
    return;
  }

  const formData = new FormData();
  formData.append('file', file);
  formData.append('categoria', currentCategory);

  const xhr = new XMLHttpRequest();
  xhr.open('PUT', '/api/capacitacion/upload', true);
  xhr.setRequestHeader('Authorization', 'Bearer ' + token);

  xhr.upload.addEventListener("progress", (e) => {
    if (e.lengthComputable) {
      const percent = (e.loaded / e.total) * 100;
      document.getElementById('progressContainer').classList.remove('hidden');
      document.getElementById('progressBar').style.width = percent + "%";
    }
  });

  xhr.onload = function() {
    const data = JSON.parse(xhr.responseText);
    document.getElementById('mensaje').innerText = data.message || "Archivo actualizado";
    if (data.fileUrl) {
      document.getElementById('archivoLink').innerText = data.fileName;
      document.getElementById('archivoLink').href = data.fileUrl;
      document.getElementById('archivoFecha').innerText = `√öltima actualizaci√≥n: ${new Date().toLocaleString()}`;
      document.getElementById('archivoEnlace').classList.remove('hidden');
    }
    renderCategorias();
  };

  xhr.send(formData);
}

// Inicializar
renderCategorias();
</script>
</body>
</html>



