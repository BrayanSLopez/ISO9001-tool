<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Capacitaci√≥n</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
</head>

<body class="min-h-screen font-sans text-gray-900 bg-gradient-to-tr from-blue-900 via-blue-500 to-blue-200 bg-fixed">
  <!-- Header -->
  <div class="max-w-4xl mx-auto p-6 flex flex-col min-h-screen">
    <!-- Header -->
    <header class="flex justify-between items-center py-4 px-6 bg-gray-50/90 rounded-xl shadow-md mt-4 border border-gray-200">
      <div class="flex items-center gap-3">
        <i class="fa-solid fa-chalkboard-user text-3xl text-green-700"></i>
        <span class="text-2xl font-extrabold text-green-700 tracking-tight">Capacitaci√≥n</span>
      </div>
      <a href="/dashboard.html" class="flex items-center gap-2 px-4 py-2 border border-green-600 text-green-600 rounded-lg hover:bg-green-600 hover:text-white transition-all font-semibold shadow-sm">
        <i class="fa-solid fa-arrow-left"></i>
        Volver
      </a>
    </header>

    <main class="flex-1 flex flex-col justify-center w-full">
      <section class="mt-8 bg-gray-50/90 p-8 rounded-2xl shadow-2xl border border-gray-200">
        <h2 class="text-xl font-bold mb-6 text-green-900 flex items-center gap-2"><i class="fa-solid fa-book-open-reader text-green-600"></i>Capacitaci√≥n y Documentos</h2>
        <!-- Lista de categor√≠as -->
        <div id="categorias" class="space-y-3"></div>
      </section>
    </main>


    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
      <div class="bg-white/95 p-6 rounded-2xl shadow-2xl w-96 relative border border-gray-200">
        <h2 id="modalTitle" class="text-lg font-bold mb-4 text-green-900 flex items-center gap-2"><i class="fa-solid fa-file-lines text-green-600"></i>Documento</h2>

        <!-- Enlace al documento base -->
        <a id="documentBaseLink" href="#" class="text-green-700 underline block mb-3 font-semibold" target="_blank">
          Descargar documento base
        </a>

        <!-- Enlace al archivo subido -->
        <div id="archivoEnlace" class="mb-3 hidden">
          <span class="font-medium">Archivo actual:</span>
          <a id="archivoLink" href="#" target="_blank" class="text-green-700 underline ml-2"></a>
          <div id="archivoFecha" class="text-xs text-gray-500"></div>
        </div>

        <!-- Subir archivo -->
        <input type="file" id="fileInput" class="mb-3" />
        <button onclick="uploadFile()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold flex items-center gap-2"><i class="fa-solid fa-upload"></i>Subir archivo</button>

        <!-- Barra de progreso -->
        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-3 hidden" id="progressContainer">
          <div id="progressBar" class="bg-green-600 h-2.5 rounded-full" style="width: 0%"></div>
        </div>

        <!-- Mensaje -->
        <p id="mensaje" class="mt-3 text-sm"></p>

        <!-- Cerrar -->
        <button onclick="closeModal()" class="absolute top-2 right-2 text-gray-500 text-2xl">&times;</button>
      </div>
    </div>

<script>
const token = localStorage.getItem('token');
if (!token) location.href = '/index.html';

let currentCategory = null;
let currentCategoryName = null;
let existingFile = null;

// Categor√≠as fijas con archivos asociados
const categorias = [
  { id: 'objetivos', nombre: 'Objetivos y Beneficios', color: 'bg-blue-600 hover:bg-blue-700', archivo: 'Objetivos.xlsx' },
  { id: 'phva', nombre: 'Ciclo PHVA', color: 'bg-green-600 hover:bg-green-700', archivo: 'PHVA.jpg' },
  { id: 'organizacion', nombre: 'Organizaci√≥n', color: 'bg-indigo-600 hover:bg-indigo-700', archivo: 'Organigrama.xlsx' },
  { id: 'liderazgo', nombre: 'Liderazgo', color: 'bg-purple-600 hover:bg-purple-700', archivo: 'Liderazgo.xlsx' },
  { id: 'planificacion', nombre: 'Planificaci√≥n', color: 'bg-teal-600 hover:bg-teal-700', archivo: 'Planificacion.xlsx' },
  { id: 'apoyo', nombre: 'Apoyo', color: 'bg-pink-600 hover:bg-pink-700', archivo: 'Apoyo.xlsx' },
  { id: 'operacion', nombre: 'Operaci√≥n', color: 'bg-yellow-600 hover:bg-yellow-700', archivo: 'Operacion.xlsx' },
  { id: 'desempeno', nombre: 'Desempe√±o', color: 'bg-orange-600 hover:bg-orange-700', archivo: 'Desempeno.xlsx' },
  { id: 'mejora', nombre: 'Mejora', color: 'bg-red-600 hover:bg-red-700', archivo: 'Mejora.xlsx' },
  { id: 'auditoria', nombre: 'Auditor√≠a', color: 'bg-gray-800 hover:bg-gray-900', archivo: 'Auditoria.xlsx' }
];

// Render categor√≠as con iconos y enlaces a documentos
async function renderCategorias() {
  const res = await fetch('/api/capacitacion/myfiles', {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const files = await res.json();
  const container = document.getElementById('categorias');
  container.innerHTML = '';

  categorias.forEach(cat => {
    const file = files.find(f => f.categoria === cat.id);
    const icon = file ? '‚úÖ' : 'üìÇ';
    const btn = document.createElement('button');
    btn.className = `w-full text-left px-4 py-3 text-white rounded-2xl bg-green-600 hover:bg-green-700 shadow-lg transition-all duration-200 font-semibold flex items-center gap-2`;
    btn.innerHTML = `${icon} ${cat.nombre}`;
    btn.onclick = () => openModal(cat.id, cat.nombre, cat.archivo);
    container.appendChild(btn);
  });
}

// Abrir modal
function openModal(category, name, archivo) {
  currentCategory = category;
  currentCategoryName = name;
  document.getElementById('modalTitle').innerText = name;
  document.getElementById('mensaje').innerText = '';
  document.getElementById('fileInput').value = '';
  document.getElementById('progressContainer').classList.add('hidden');
  existingFile = null;

  // Actualizar el enlace de descarga
  const documentLink = document.getElementById('documentBaseLink');
  documentLink.href = `/docs/${archivo}`;
  documentLink.innerText = `Descargar ${name} (Documento Base)`;

  // Cargar archivo actual del usuario
  fetch('/api/capacitacion/myfiles', {
    headers: { 'Authorization': 'Bearer ' + token }
  })
    .then(res => res.json())
    .then(data => {
      const f = data.find(x => x.categoria === category);
      if (f) {
        existingFile = f;
        document.getElementById('archivoLink').innerText = f.nombre_original;
        document.getElementById('archivoLink').href = f.ruta_archivo;
        document.getElementById('archivoFecha').innerText = `√öltima actualizaci√≥n: ${f.fecha_subida}`;
        document.getElementById('archivoEnlace').classList.remove('hidden');
      } else {
        document.getElementById('archivoEnlace').classList.add('hidden');
      }
    });

  document.getElementById('modal').classList.remove('hidden');
}

// Cerrar modal
function closeModal() {
  document.getElementById('modal').classList.add('hidden');
}

// Subir archivo con confirmaci√≥n y progreso
function uploadFile() {
  const file = document.getElementById('fileInput').files[0];
  if (!file) {
    alert("Selecciona un archivo");
    return;
  }

  if (existingFile && !confirm("Ya existe un archivo en esta categor√≠a. ¬øDeseas reemplazarlo?")) {
    return;
  }

  const formData = new FormData();
  formData.append('file', file);
  formData.append('categoria', currentCategory);

  const xhr = new XMLHttpRequest();
  xhr.open('PUT', '/api/capacitacion/upload', true);
  xhr.setRequestHeader('Authorization', 'Bearer ' + token);

  xhr.upload.addEventListener("progress", (e) => {
    if (e.lengthComputable) {
      const percent = (e.loaded / e.total) * 100;
      document.getElementById('progressContainer').classList.remove('hidden');
      document.getElementById('progressBar').style.width = percent + "%";
    }
  });

  xhr.onload = function() {
    const data = JSON.parse(xhr.responseText);
    document.getElementById('mensaje').innerText = data.message || "Archivo actualizado";
    if (data.fileUrl) {
      document.getElementById('archivoLink').innerText = data.fileName;
      document.getElementById('archivoLink').href = data.fileUrl;
      document.getElementById('archivoFecha').innerText = `√öltima actualizaci√≥n: ${new Date().toLocaleString()}`;
      document.getElementById('archivoEnlace').classList.remove('hidden');
    }
    renderCategorias();
  };

  xhr.send(formData);
}

// Inicializar
renderCategorias();

  </script>
  <!-- Footer -->
  <footer class="mt-10 text-center text-white text-sm py-4 border-t border-green-300 bg-green-800/90 rounded-b-xl shadow-lg w-full max-w-4xl mx-auto">
    <div class="flex flex-col md:flex-row justify-center items-center gap-2">
      <span class="font-semibold">&copy; 2025 ISO9001 Tool - Capacitaci√≥n</span>
      <span class="hidden md:inline">|</span>
      <a href="mailto:soporte@iso9001tool.com" class="hover:underline text-cyan-200 font-medium"><i class="fa-solid fa-envelope"></i> Contacto</a>
      <span class="hidden md:inline">|</span>
      <a href="https://www.iso.org/iso-9001-quality-management.html" target="_blank" class="hover:underline text-cyan-200 font-medium"><i class="fa-solid fa-globe"></i> M√°s sobre ISO 9001</a>
    </div>
  </footer>
</body>
</html>




