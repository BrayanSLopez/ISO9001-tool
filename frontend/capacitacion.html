<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Capacitación</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-6">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-xl font-bold">Capacitación</h2>

    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <h3 class="font-semibold">Documentos base</h3>
        <div id="docsList" class="mt-2 space-y-2"></div>
      </div>

      <div>
        <h3 class="font-semibold">Subir archivo aplicado</h3>
        <form id="uploadForm" class="space-y-2">
          <select id="categoria" class="border p-2 rounded w-full">
            <option value="objetivos">Objetivos y beneficios</option>
            <option value="phva">Ciclo PHVA</option>
            <option value="organizacion">Organización</option>
          </select>
          <input id="empresa_id" placeholder="Empresa ID (opcional)" class="border p-2 rounded w-full" />
          <input type="file" id="fileInput" class="w-full" />
          <button class="bg-green-600 text-white p-2 rounded" type="button" id="btnUpload">Subir</button>
        </form>

        <h4 class="mt-4 font-semibold">Mis archivos</h4>
        <div id="myFiles" class="mt-2"></div>
      </div>
    </div>

  </div>

<script>
const token = localStorage.getItem('token');
if (!token) location.href = '/index.html';

async function loadDocs() {
  const res = await fetch('/api/capacitacion/docs');
  const data = await res.json();
  const el = document.getElementById('docsList');
  el.innerHTML = '';
  for (const d of data) {
    const a = document.createElement('a');
    a.href = d.url; a.target = '_blank';
    a.className = 'block p-2 border rounded';
    a.innerText = d.nombre;
    el.appendChild(a);
  }
}

async function loadMyFiles() {
  const res = await fetch('/api/capacitacion/myfiles', {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const data = await res.json();
  const el = document.getElementById('myFiles');
  el.innerHTML = '';
  for (const f of data) {
    const div = document.createElement('div');
    div.className = 'p-2 border rounded mb-1';
    div.innerHTML = `<a href="${f.ruta_archivo}" target="_blank">${f.nombre_original}</a> <div class="text-xs text-gray-500">${f.categoria} - ${f.fecha_subida}</div>`;
    el.appendChild(div);
  }
}

document.getElementById('btnUpload').addEventListener('click', async () => {
  const file = document.getElementById('fileInput').files[0];
  if (!file) return alert('Selecciona un archivo');
  const categoria = document.getElementById('categoria').value;
  const empresa_id = document.getElementById('empresa_id').value || '';
  const fd = new FormData();
  fd.append('file', file);
  fd.append('categoria', categoria);
  fd.append('empresa_id', empresa_id);

  const res = await fetch('/api/capacitacion/upload', {
    method: 'POST',
    headers: { 'Authorization': 'Bearer ' + token },
    body: fd
  });
  const data = await res.json();
  if (res.ok) {
    alert('Archivo subido');
    loadMyFiles();
  } else {
    alert('Error: ' + (data.error || JSON.stringify(data)));
  }
});

loadDocs();
loadMyFiles();
</script>
</body>
</html>
